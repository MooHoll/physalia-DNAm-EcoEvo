# DNA Methylation in Ecology and Evolution

### Physalia-Courses 

# Short-reads workshop Day 2 // 11th February, 2025
### Instructor: Hollie Marshall

This is the Readme file for the session on Tuesday, where we will cover the second half of the short-read processing. All the data you'll need for this will be stored in: 

`~/Share/2_Tuesday/`

## Overview

Using the same data as yesterday, we will; examine the bisulfite conversion rate, extract readable DNA methylation C/T count data and account for genetic variation caused by SNPs.

## 1. Examining the Bisulfite / Enzymatic conversion rate

For WGBS/RRBS a 1% spike of lambda phage genome is included in the DNA sample before bisulfite conversion. Lambda is unmethylated so acts as a negative control to understand how efficent the bisulfite converstion is. For EM-Seq both a lambda (negative control) and pUC19 (plasmid positive control - fully methylated) are used. It is also possible to check the conversation rate of samples by examining the chloroplast/mitochondria sequences as these are thought to be unmethylated. However, this has recently been questioned and so it is always better to use a controlled spike.

Today for ease, we will check the conversion rate of the Arabidopsis data using the chloroplast genome.

### Core Tasks:
* Copy the Arabidopsis chloroplast genome into your area
* Using what you learnt yesterday, prepare the genome using bismark
* Align your sequence files to the chloroplast genome
* Examine the output report - what is your conversion rate?

### Advanced Tasks:
* Write a loop to align multiple sequencing files
* Create a short Snakemake script to align multiple sequencing files
* Attempt this on your own HPC using your own data (or practice data from NCBI)

Whilst primarily checking the conversion rate ensures your data are of good quality. It is also important for later downstream processing of the data. We use this number as an error level when carrying out binomial tests to call positions as methylated/unmethylated.

*Other than recording the conversion rate, we do not use any of these files for further steps.*


## 2. Extracting Useable Methylation Counts

After creating `.bam` files by aligning the sequencing data to the species reference genome, we must now convert these files into useable dataframes of methylation information. This is simply achieved with a few more `Bismark` commands.

### Core Tasks:
* Examine the `Bismark` documentation: [https://felixkrueger.github.io/Bismark/](https://felixkrueger.github.io/Bismark/)
* Carry out deduplication of your `.bam` files
* Carry out `methylation_extraction` (see code below)

You will see there are lots of options for creating lots of different files depending on what you want to do with your data. For simple differential DNA methylation analysis, all we need is the coverage file. Generated by running the below step:

```
bismark_methylation_extractor --multicore 3 --comprehensive --bedGraph --report --cytosine_report \
--genome_folder TAIR10_genome/ <your_deduplicated>.bam

bismark2report ./
```

* Examine your HTML report by downloading the `.html` files to your computer
* Do you think you should run `methylation_extraction` again using the `--ignore` options?

Once you are happy with your final extracted files these can be used for differential DNA methylation analyses in R (Day 4). 


**Optional:**\
We can run one more command which merges the calls across strands. As CpGs consist of a C on both the positive and negative DNA strand, we can merge this information to create a single CpG position for later anaysis. This is a personal decision based on your research question, you may be interested in knowing what's happening on both strands, or not...

* Carry out the strand merge

```
coverage2cytosine -o <file_name> --merge_CpGs --genome_folder TAIR10_genome/ <your_deduplicated>.bam

bismark2report ./
```

These merged coverage files can also go straight into the differential DNA methylation pipeline.

### Advanced Tasks:
* Write a loop to carry out each step for all files
* Add the above steps to your Snakemake script
* Attempt this on your own HPC using your own data (or practice data from NCBI)

## 3. Accounting for SNPs

Most of the time the sample you are looking at comes from an different individual / genetic line than the one that was used to make the reference genome for your species. Therefore your sample will contain SNPs which differ to the reference genome. As bisulfite conversion converts C-->T we need to account for C/T SNPs in your sample to avoid miscalling incorrect DNA methylation differences between your sample and the reference genome. James will talk more about this on Day 4 but also see [de Carvalho et al. preprint](https://zenodo.org/records/14671205).

If you have whole genome resequencing data (or are using long-reads - see Day 3), this is easily done by removing the SNP positions from your methylation call files. We will provide you with `.vcf` files which contain SNP calls. However, we also provide a pipeline for calling SNPs in `bonus_stuff`.

*NOTE: if you're interested in genetic differeneces between your samples, as well as methylation differences, you can save this step until after you've carried out your differential DNA methylation analysis (Day4). It's possible to do some pretty interesting stuff with these data - see [Venney et al. 2024](https://doi.org/10.1093/gbe/evae013).*

### Core Tasks:
* Make two SNP position files, one for C/T and one G/A SNPs, from the vcf files provided
* Run the `filter_SNPs_from_covfile.sh` file twice (once for each SNP position file) to remove SNPs from your coverage file

### Advanced Tasks:
* Edit the `filter_SNPs_from_covfile.sh` file to re-name your final output file to something shorter
* Write a loop to run this for multiple coverage files, with different vcf files each (this is tricker than you'd think)

## Summary
The steps from Day 1 and Day 2 are the full pipeline to process raw short-read data into useable DNA methylation count files, ready for whatever analysis you want to do. 

This pipleine produces a lot of files, the final bits you actually need are:
* Alignment rate
* Bisulfite conversion rate
* Coverage file (either the original, merged or SNP filtered version)
