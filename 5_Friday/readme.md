# DNA Methylation in Ecology and Evolution

### Physalia-Courses 

# Advanced DNA methylation workshop Day 5 // 14th February, 2025
### Instructor: Hollie Marshall

This is the Readme file for the session on Friday, where we will cover genome-wide DNA methylation profiling and correlations with gene expression in `R`. All the data you'll need for this will be stored in: 

`~/Share/5_Friday/`

## Overview

Today we will work from files created on Day 2 (or Day 3), the final `coverage` files. We will calculate the methylation level over regions of the genome, such as exons, promoters or whole genes. Specifically we will calcultae the **weighted methylation level** for these genomic regions. These feature-specific methylation levels can then be correlated with gene expression or used for a number of other purposes depending on your project.

## 1. Weighted methylation of a region
Weighted methylation level is simply the sum of all Cs divided by the total coverage of a region. This allows us to take into account the number of CpGs per region and give more weight to those with more coverage. It is similar to the percentage methylation level per C, but across an entire region of interest.

Full details on how weighted methylation is calculated can be found in [Schultz et al. 2012](https://www.cell.com/trends/genetics/abstract/S0168-9525(12)00171-0?_returnURL=https%3A%2F%2Flinkinghub.elsevier.com%2Fretrieve%2Fpii%2FS0168952512001710%3Fshowall%3Dtrue).

### Step 1: Get the files we need
*We won't actually do step 1 today, I will provide you with these files.*

* Edit the `coverage` files generated by bismark to make them more user friendly

```
for file in $(ls *cov)
do
    base=$(basename ${file} ".CpG_report.merged_CpG_evidence.cov")
    cut -f1,2,5,6 ${file} > ${base}_coverage.txt
done
```

In `R`:
```
library(readr)

file.list = list.files(("./"),pattern="*_coverage.txt")

read_file1 <- function(x){
  read_delim(x, "\t", col_names=F)
}

samples <- lapply(file.list, read_file1)

sample_names <- list("sample1","sample2","sample3")

names(samples) <- sample_names

for(i in seq_along(samples)){
    colnames(samples[[i]]) <- c("chr", "cpg", "count_c", "count_t")
    samples[[i]]$total_coverage <- samples[[i]]$count_c + samples[[i]]$count_t
    samples[[i]] <- samples[[i]][,-4]
    final_file <- samples[[i]]
    myfile <- file.path("./", paste0(names(samples[i]),"_","final_coverage.txt"))
    write.table(final_file, file=myfile, quote=F, sep="\t", row.names=F)
}
```

* We also need a `.bed` file with regions that we're interested in, e.g. genes, exons, etc. There are lots of ways you can make these, here are a few lines of code that strip away parts of a .gff to leave only the bits we need: `chromosome`,`feature`,`start`,`end`,`gene_id`.

```
cut -f 1,4,5,9 random_species.gff3 > random_species_annotation.bed
sed -i "s/ID=//g" random_species_annotation.bed
sed -i "s/;.*//g" random_species_annotation.bed
```
### Step 2: Calculate the weighted methylation level for all genes

* Follow the `R` script: `weighted_meth_per_feature.R` using the files provided
*Use the small versions of the files to try to get it working, the larger versions are full `coverage` and `annotation` files for Daphnia magna - a species of waterflea.*

### Step 3: Make some nice plots to see what's going on genome-wide
